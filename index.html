<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Aniversariantes da Educa√ß√£o</title>

<link rel="manifest" href="manifest.json">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Anivers√°rios">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

<style>
  /* --- CONFIGURA√á√ïES GERAIS --- */
  :root {
    --primary: #27ae60; 
    --primary-dark: #1e8449; 
    --bg-screen: #ffffff;
    --text-color: #2c3e50;
    --border-color: #e0e0e0;
    --emoji-font: 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', sans-serif;
  }

  * { box-sizing: border-box; }

  html, body { 
      margin: 0; padding: 0; 
      font-family: 'Poppins', sans-serif; 
      background: var(--bg-screen);
      height: 100%;
      -webkit-tap-highlight-color: transparent;
  }

  /* ========================================= */
  /* ESTILOS DE TELA (INTERATIVO)             */
  /* ========================================= */
  
  .screen-widget {
      background: var(--bg-screen);
      width: 100%;
      max-width: 1000px; 
      height: 100vh;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      position: relative;
  }

  /* Cabe√ßalho */
  .nav-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-shrink: 0; }
  .month-title { font-size: 1.2rem; font-weight: 700; color: var(--primary); text-transform: capitalize; margin: 0; text-align: center; }
  .nav-btn { background: #eafff2; color: var(--primary); border: none; width: 35px; height: 35px; border-radius: 8px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; }
  .nav-btn:hover { background: var(--primary); color: #fff; }

  /* FERRAMENTAS (CONTAINER) */
  .tools-row { 
      display: flex; 
      gap: 10px; /* Espa√ßo entre os bot√µes */
      margin-bottom: 15px; 
      flex-shrink: 0; 
      height: 45px; 
      position: relative; 
      align-items: center;
      justify-content: flex-end; /* Alinha √† direita se sobrar espa√ßo */
  }
  
  /* 1. BARRA DE BUSCA (DESKTOP PADR√ÉO) */
  .search-container {
      flex-grow: 1; /* Ocupa o espa√ßo que sobra */
      display: flex;
      align-items: center;
      background: #f9f9f9;
      border-radius: 8px;
      border: 1px solid #eee;
      transition: all 0.3s ease;
      height: 100%;
      padding: 0 10px;
      position: relative;
  }
  
  .search-icon-btn {
      background: transparent; border: none;
      font-size: 1.2rem; color: #666;
      cursor: pointer; display: flex; align-items: center;
      padding: 0;
  }

  .search-input { 
      border: none; background: transparent; 
      flex-grow: 1; outline: none; margin-left: 8px; 
      font-family: inherit; color: var(--text-color); font-size: 1rem; 
      font-size: 16px; width: 100%;
  }

  .search-close-btn {
      display: none; /* Escondido no Desktop */
      background: none; border: none;
      font-size: 1.2rem; color: #999;
      cursor: pointer; padding: 0 5px;
  }

  /* 2. BOT√ÉO NOTIFICA√á√ÉO */
  .notify-btn {
      background: #fff; border: 1px solid #eee; color: #f39c12;
      border-radius: 8px; width: 45px; height: 100%;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      font-size: 1.2rem; transition: 0.2s; flex-shrink: 0;
  }
  .notify-btn.active { background: #fff8e1; border-color: #f39c12; }

  /* 3. BOT√ÉO IMPRIMIR */
  .print-btn-top { 
      background: var(--primary); 
      color: white; border: none; 
      border-radius: 8px; 
      height: 100%;
      padding: 0 20px; 
      cursor: pointer; 
      font-weight: 600; 
      font-size: 0.95rem; 
      display: flex; align-items: center; gap: 8px; 
      transition: 0.2s; white-space: nowrap; flex-shrink: 0;
  }
  .print-btn-top:hover { background: var(--primary-dark); transform: translateY(-1px); }

  /* --- RESPONSIVIDADE (MOBILE) --- */
  @media (max-width: 600px) {
      .screen-widget { padding: 15px; }
      
      /* Bot√£o Imprimir vira √≠cone quadrado */
      .print-btn-text { display: none; }
      .print-btn-top { padding: 0; width: 45px; justify-content: center; }
      
      /* Barra de Busca vira √≠cone quadrado (fechada) */
      .search-container {
          flex-grow: 0; /* N√£o cresce */
          width: 45px;  /* Tamanho fixo */
          padding: 0;
          justify-content: center;
          cursor: pointer;
      }
      .search-input { display: none; } /* Esconde input */
      .search-icon-btn { pointer-events: none; } /* Clique vai no container */

      /* Barra de Busca (ABERTA) */
      .search-container.active {
          position: absolute; /* Flutua sobre os outros */
          top: 0; left: 0; right: 0;
          width: 100%; /* Ocupa tudo */
          z-index: 50; /* Fica por cima */
          background: #fff;
          border-color: var(--primary);
          padding: 0 10px;
          justify-content: flex-start;
          box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      }
      .search-container.active .search-input { display: block; }
      .search-container.active .search-close-btn { display: block; }
      
      .month-title { font-size: 1rem; }
      .hero-names { font-size: 1.1rem; }
      .hero-msg { font-size: 0.8rem; }
  }

  /* Hero Section */
  .hero-box {
      background: linear-gradient(135deg, #27ae60, #1e8449);
      color: white;
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      margin-bottom: 15px;
      position: relative;
      overflow: hidden;
      flex-shrink: 0;
      box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
      min-height: 130px;
      display: flex; flex-direction: column; justify-content: center; align-items: center;
  }
  .hero-icon { font-size: 2.2rem; display: block; margin-bottom: 2px; cursor: pointer; transition: transform 0.2s; position: relative; z-index: 2; font-family: var(--emoji-font); }
  .hero-names { font-size: 1.3rem; font-weight: 700; margin: 2px 0; line-height: 1.2; position: relative; z-index: 2; }
  .hero-msg { font-size: 0.9rem; font-style: italic; opacity: 0.9; margin-top: 5px; white-space: pre-line; position: relative; z-index: 2; }
  
  #particle-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
  .particle { position: absolute; bottom: -20px; animation: riseUp 2s linear forwards; }
  @keyframes riseUp { to { transform: translateY(-150px) rotate(360deg); opacity: 0; } }

  /* Lista Tela */
  .scroll-list { flex-grow: 1; overflow-y: auto; padding-right: 5px; }
  .scroll-list::-webkit-scrollbar { width: 8px; }
  .scroll-list::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }

  .list-item { display: flex; align-items: center; padding: 10px 5px; border-bottom: 1px solid #f0f0f0; transition: 0.2s; }
  .list-item:hover { background: #fdfdfd; }
  .list-item.today { background: #eafff2; border-left: 4px solid var(--primary); border-radius: 4px; }
  
  .date-badge { 
      background: #f4f4f4; color: #555; 
      width: 50px; height: 50px; 
      border-radius: 10px; 
      display: flex; flex-direction: column; 
      align-items: center; justify-content: center; 
      margin-right: 15px; flex-shrink: 0; 
      line-height: 1;
  }
  .today .date-badge { background: var(--primary); color: white; }
  
  .db-day { font-size: 1.1rem; font-weight: 700; }
  .db-week { font-size: 0.55rem; text-transform: uppercase; margin-top: 2px; }
  .db-month { font-size: 0.55rem; text-transform: uppercase; font-weight: 700; margin-top: 1px; color: var(--primary-dark); }
  .today .db-month { color: #eafff2; }

  .name-text { font-weight: 600; font-size: 1rem; color: var(--text-color); flex-grow: 1; }
  .wa-btn { background: #25D366; color: white; border: none; border-radius: 20px; padding: 6px 12px; font-size: 0.75rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px; text-decoration: none; }

  /* ========================================= */
  /* ESTILOS DE IMPRESS√ÉO (A4 LIMPO)          */
  /* ========================================= */
  
  #print-container { display: none; }

  @media print {
      @page { size: A4; margin: 0; }
      body { background: white; -webkit-print-color-adjust: exact; print-color-adjust: exact; height: auto; }
      .screen-widget { display: none !important; }
      #print-container { display: block !important; }

      .a4-sheet {
          width: 210mm; height: 297mm; position: relative; margin: 0 auto; background: white; overflow: hidden; 
          padding: 20mm 20mm 20mm 20mm; display: flex; flex-direction: column;
      }

      .print-border { display: none; }

      .print-content-wrapper {
          position: absolute; top: 35mm; left: 22mm; right: 22mm; bottom: 20mm; 
          display: flex; flex-direction: column; z-index: 1;
      }

      .p-header { text-align: center; border-bottom: 2px solid var(--primary); padding-bottom: 8px; margin-bottom: 12px; flex-shrink: 0; }
      .p-emojis { font-family: var(--emoji-font); font-size: 1.3rem; letter-spacing: 12px; margin-bottom: 2px; }
      .p-title { font-size: 1.6rem; font-weight: 800; color: var(--primary); text-transform: uppercase; margin: 0; line-height: 1.2; }

      .p-list-grid {
          flex-grow: 1; display: grid; grid-template-columns: 1fr 1fr; column-gap: 25px; align-content: start; row-gap: 10px; overflow: hidden; 
      }

      .p-item { display: flex; align-items: center; border-bottom: 1px solid #eee; padding: 4px 0; break-inside: avoid; min-height: 40px; }

      .p-date-box {
          width: 40px; height: 40px; background-color: #f3f4f6 !important; border: 1px solid #ccc; border-radius: 5px; display: flex; flex-direction: column; align-items: center; justify-content: center; margin-right: 10px; color: #333 !important; flex-shrink: 0; line-height: 1;
      }
      .pd-day { font-size: 1rem; font-weight: bold; }
      .pd-week { font-size: 0.5rem; text-transform: uppercase; margin-top: 1px; }
      .pd-month { font-size: 0.5rem; text-transform: uppercase; font-weight: 700; margin-top: 0px; }

      .p-name { font-size: 1rem; color: #2c3e50; font-weight: 600; line-height: 1.1; white-space: normal; word-wrap: break-word; }

      .p-footer { text-align: center; border-top: 1px solid var(--primary); padding-top: 8px; margin-top: 10px; flex-shrink: 0; color: var(--primary); font-weight: 600; font-size: 0.85rem; }
      .p-footer-emoji { font-family: var(--emoji-font); font-size: 1rem; margin-top: 2px; letter-spacing: 5px; }
  }
</style>
</head>
<body>

<div class="screen-widget">
    <div class="nav-header">
        <button class="nav-btn" onclick="changeMonth(-1)">&#10094;</button>
        <h2 id="screen-month-title" class="month-title">M√™s Atual</h2>
        <button class="nav-btn" onclick="changeMonth(1)">&#10095;</button>
        <button id="btn-reset" class="nav-btn" style="display:none; margin-left:10px; width:auto; padding:0 10px; font-size:0.8rem;" onclick="resetSearch()">‚úñ</button>
    </div>

    <div class="tools-row">
        <div class="search-container" id="search-container" onclick="openSearchMobile(event)">
            <button class="search-icon-btn">üîç</button>
            <input type="text" id="search-input" class="search-input" placeholder="Pesquisar..." onkeyup="handleSearch()">
            <button class="search-close-btn" onclick="closeSearchMobile(event)">‚úï</button>
        </div>

        <button class="notify-btn" id="btn-notification" onclick="requestNotificationPermission()" title="Ativar Notifica√ß√µes">
            üîî
        </button>

        <button class="print-btn-top" onclick="prepareAndPrint()" title="Imprimir">
            üñ®Ô∏è <span class="print-btn-text">Imprimir</span>
        </button>
    </div>

    <div class="hero-box" id="hero-box">
        <div id="particle-layer"></div>
        <span id="hero-emoji" class="hero-icon">üéÇ</span>
        <div id="hero-names" class="hero-names">Aniversariantes</div>
        <div id="hero-msg" class="hero-msg"></div>
    </div>

    <div class="scroll-list" id="screen-list"></div>
</div>

<div id="print-container">
    <div class="a4-sheet">
        <div class="print-border"></div> 
        <div class="print-content-wrapper">
            
            <div class="p-header">
                <div class="p-emojis">üéÅüéâüéÇü•≥üéà</div>
                <h1 id="print-title" class="p-title">ANIVERSARIANTES</h1>
            </div>

            <div id="print-list-grid" class="p-list-grid"></div>

            <div class="p-footer">
                <div>Com carinho,</div>
                <div>Secretaria Municipal de Educa√ß√£o de Orindi√∫va üíö</div>
                <div class="p-footer-emoji">üéàüéÅüéÇ‚ú®</div>
            </div>

        </div>
    </div>
</div>

<script>
  // --- CONFIGURA√á√ïES ---
  const CALENDAR_ID = 'c_aac01d0cbc7c5ed5147d0b02239e95cc283095daff716e32cb79d53bd184370b@group.calendar.google.com'; 
  const API_KEY = 'AIzaSyDuCPt6S-mF33IGaMnYtiYLJlDjaXJG4wA'; 
  const ASSINATURA = "\n\nCom carinho,\nSecretaria Municipal de Educa√ß√£o de Orindi√∫va.";
  
  // --- 30 FRASES ---
  const frases = [
    "Feliz Anivers√°rio! Desejamos a voc√™ um dia cheio de alegria e realiza√ß√µes. Sua dedica√ß√£o √† educa√ß√£o √© admir√°vel e inspiradora. Que este novo ano de vida lhe traga muito sucesso, alegrias e paz. üéÇüéâü•≥üéàüíö",
    "Parab√©ns! Que seu dia seja iluminado e repleto de sorrisos. Agradecemos profundamente pelo seu compromisso com o futuro das nossas crian√ßas. Felicidades mil! ‚ú®üìöüéÅ",
    "Hoje √© dia de celebrar voc√™! Que a vida continue te presenteando com sabedoria, sa√∫de e muito amor. Obrigado por fazer a diferen√ßa na nossa educa√ß√£o. Viva! üëèüéÇüéà",
    "Feliz vida! Que este novo ciclo venha carregado de boas energias e momentos inesquec√≠veis. Sua presen√ßa em nossa equipe √© um presente para todos n√≥s. üåüüíêüéâ",
    "Parab√©ns pelo seu dia! Que a felicidade seja constante em sua vida e que voc√™ continue trilhando este lindo caminho na educa√ß√£o com tanto carinho. ü•≥üç∞üéÅ",
    "Um feliz anivers√°rio cheio de luz! Desejamos que voc√™ realize todos os seus sonhos e continue inspirando alunos e colegas com seu exemplo. Gratid√£o! ‚ú®üôèüéà",
    "Viva! Hoje o dia √© todo seu. Que a alegria transborde e que o ano novo que se inicia traga muitas conquistas pessoais e profissionais. Parab√©ns! üéÇü•Çüíö",
    "Feliz Anivers√°rio! Que a paz e o amor estejam sempre presentes na sua caminhada. Voc√™ √© parte fundamental da nossa hist√≥ria na educa√ß√£o. Sucesso! üìöüéâüëè",
    "Parab√©ns! Desejamos muita sa√∫de para continuar essa jornada linda de ensinar e aprender. Que seu dia seja doce e especial como voc√™ merece. üç≠üç∞üéÅ",
    "Hoje celebramos sua vida! Que o brilho nos seus olhos nunca se apague. Agradecemos por toda a dedica√ß√£o e carinho que voc√™ coloca em tudo que faz. ‚ú®üéàü•≥",
    "Felicidades! Que este anivers√°rio marque o in√≠cio de um ano incr√≠vel, repleto de vit√≥rias e aprendizados. Voc√™ √© essencial para n√≥s! üåüüíöüéÇ",
    "Parab√©ns pelo seu dia! Que voc√™ colha em dobro todo o bem e conhecimento que planta diariamente. Tenha um dia maravilhoso! üå∫üìöüéâ",
    "Feliz Anivers√°rio! Que a vida lhe sorria sempre, trazendo sa√∫de, prosperidade e muitas b√™n√ß√£os. Obrigado por ser quem voc√™ √©. üôåüéÅüéà",
    "Dia de festa! Comemore muito, pois voc√™ merece toda a felicidade do mundo. Sua paix√£o pela educa√ß√£o nos motiva. Parab√©ns! ü•≥üéÇü•Ç",
    "Feliz novo ciclo! Que a sabedoria e a paci√™ncia continuem sendo suas virtudes. Desejamos um caminho florido e cheio de luz. üå∏‚ú®üíö",
    "Parab√©ns! Que a alegria de hoje se estenda por todos os dias do ano. Sua contribui√ß√£o para a educa√ß√£o de Orindi√∫va √© inestim√°vel. üìöüëèüéâ",
    "Feliz Anivers√°rio! Que voc√™ continue sendo essa luz que guia e acolhe. Muita paz, sa√∫de e amor no seu cora√ß√£o. üíñüç∞üéà",
    "Celebre a vida! Que seus passos sejam sempre firmes e seus sonhos alcan√ßados. Gratid√£o por compartilhar seu talento conosco. Parab√©ns! üåüüéÅü•≥",
    "Parab√©ns! Desejamos um dia repleto de abra√ßos sinceros e carinho. Que sua jornada na educa√ß√£o continue sendo brilhante. ‚ú®üìöüéÇ",
    "Feliz dia! Que a harmonia e o sucesso fa√ßam morada em sua vida. Agradecemos por sua entrega e profissionalismo di√°rios. ü•Çüíöüéà",
    "Viva voc√™! Que a vida lhe reserve as melhores surpresas. Obrigado por construir o conhecimento com tanto amor. Felicidades! üß±‚ù§Ô∏èüéâ",
    "Parab√©ns! Que a sa√∫de nunca falte e que a alegria seja sua rotina. Voc√™ faz a diferen√ßa na vida de muitos. Aproveite seu dia! üëèüç∞üéÅ",
    "Feliz Anivers√°rio! Que este novo ano seja um cap√≠tulo lindo na sua hist√≥ria, cheio de conquistas e sorrisos. Estamos felizes em ter voc√™ aqui. üìñ‚ú®ü•≥",
    "Parab√©ns! Que a esperan√ßa e a f√© renovem suas energias. Sua dedica√ß√£o √© a semente de um futuro melhor. Tudo de bom! üå±üíöüéÇ",
    "Hoje √© dia de gratid√£o pela sua vida! Que voc√™ receba em dobro todo o carinho que doa. Tenha um anivers√°rio espetacular! üéâüéàüéÅ",
    "Felicidades! Que sua estrela continue brilhando forte. A educa√ß√£o se fortalece com pessoas como voc√™. Parab√©ns! ‚≠êüìöü•Ç",
    "Feliz Anivers√°rio! Que o amor e a paz envolvam seu cora√ß√£o hoje e sempre. Obrigado por sua parceria e empenho constantes. ü§ùüíñüç∞",
    "Parab√©ns! Que voc√™ tenha um ano de muitas realiza√ß√µes e crescimento. Sua trajet√≥ria nos orgulha muito. Viva! üèÜüåüü•≥",
    "Feliz vida! Que a simplicidade e a alegria dos pequenos momentos tornem seu dia grandioso. Parab√©ns por mais um ano! üéàüåøüéÇ",
    "Parab√©ns! Desejamos que seu caminho seja sempre iluminado e que voc√™ continue transformando vidas atrav√©s da educa√ß√£o. Felicidades! üí°üìöüíö"
  ];

  let currentDate = new Date();
  let eventsCache = []; 
  let isSearchMode = false;
  let particleInterval = null;

  function init() { 
      updateScreenHeader(); 
      fetchEvents(); 
      setupParticles(); 
      registerServiceWorker();
      
      // CONFIGURA√á√ÉO DO FECHAMENTO AUTOM√ÅTICO DA BUSCA
      document.addEventListener('click', function(event) {
          const searchContainer = document.getElementById('search-container');
          const isClickInside = searchContainer.contains(event.target);
          if (!isClickInside && searchContainer.classList.contains('active')) {
              closeSearchMobile(null); 
          }
      });
  }

  // --- SERVICE WORKER & NOTIFICA√á√ïES ---
  function registerServiceWorker() {
      if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('SW registrado', reg))
          .catch(err => console.log('SW falhou', err));
      }
      if (Notification.permission === 'granted') {
          document.getElementById('btn-notification').classList.add('active');
      }
  }

  function requestNotificationPermission() {
      Notification.requestPermission().then(permission => {
          if (permission === "granted") {
              document.getElementById('btn-notification').classList.add('active');
              new Notification("Notifica√ß√µes Ativadas!", {
                  body: "Voc√™ ser√° avisado quando houver aniversariantes.",
                  icon: "https://img.icons8.com/fluency/512/birthday-cake.png"
              });
              checkBirthdaysAndNotify(eventsCache);
          }
      });
  }

  function checkBirthdaysAndNotify(items) {
      if (Notification.permission !== 'granted') return;
      
      const todays = items.filter(i => i.isToday);
      const todayKey = 'notified_' + new Date().toDateString();
      if (localStorage.getItem(todayKey)) return;

      if (todays.length > 0) {
          const names = todays.map(i => i.name).join(', ');
          new Notification("üéâ Tem bolo hoje!", {
              body: `Hoje √© anivers√°rio de: ${names}. Clique para parabenizar!`,
              icon: "https://img.icons8.com/fluency/512/birthday-cake.png"
          });
          localStorage.setItem(todayKey, 'true');
      }
  }

  // --- CONTROLES DE BUSCA MOBILE ---
  function openSearchMobile(event) {
      if (window.innerWidth <= 600) {
          if (event && (event.target.classList.contains('search-close-btn') || event.target.tagName === 'INPUT')) {
              return;
          }
          const container = document.getElementById('search-container');
          container.classList.add('active');
          document.getElementById('search-input').focus();
          if(event) event.stopPropagation(); 
      }
  }

  function closeSearchMobile(e) {
      if(e) e.stopPropagation();
      const container = document.getElementById('search-container');
      container.classList.remove('active');
      document.getElementById('search-input').value = '';
      if(isSearchMode) resetSearch();
  }

  // --- DADOS ---
  async function fetchEvents(query = "") {
    const listDiv = document.getElementById('screen-list');
    listDiv.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">Carregando...</div>';
    const year = currentDate.getFullYear();
    let timeMin, timeMax;

    if (query) {
        timeMin = new Date(year, 0, 1).toISOString();
        timeMax = new Date(year, 11, 31).toISOString();
        document.getElementById('screen-month-title').innerText = "Busca";
        document.getElementById('btn-reset').style.display = 'flex';
    } else {
        const month = currentDate.getMonth();
        timeMin = new Date(year, month, 1).toISOString();
        timeMax = new Date(year, month + 1, 0, 23, 59, 59).toISOString();
        updateScreenHeader();
        document.getElementById('btn-reset').style.display = 'none';
    }

    const url = `https://www.googleapis.com/calendar/v3/calendars/${encodeURIComponent(CALENDAR_ID)}/events?key=${API_KEY}&timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime&maxResults=2500`;

    try {
        const resp = await fetch(url);
        const data = await resp.json();
        let items = data.items || [];
        if (query) items = items.filter(e => e.summary && e.summary.toLowerCase().includes(query.toLowerCase()));

        const processed = items.map(evt => {
            let date = new Date(evt.start.date || evt.start.dateTime);
            if(evt.start.date) date = new Date(date.getUTCFullYear(), date.getUTCMonth(), date.getUTCDate());
            return { name: evt.summary, date: date, day: date.getDate(), month: date.getMonth(), isToday: isToday(date) };
        });

        processed.sort((a,b) => {
            if (!query && (a.isToday && !b.isToday)) return -1;
            if (!query && (!a.isToday && b.isToday)) return 1;
            if (a.month !== b.month) return a.month - b.month;
            return a.day - b.day;
        });

        eventsCache = processed;
        renderScreenList(processed);
        updateHero(processed, query);
        if(!query) checkBirthdaysAndNotify(processed);

    } catch (err) { listDiv.innerHTML = '<div style="text-align:center; color:red;">Erro ao carregar.</div>'; }
  }

  function isToday(date) { const now = new Date(); return date.getDate() === now.getDate() && date.getMonth() === now.getMonth(); }

  // --- TELA ---
  function renderScreenList(items) {
      const container = document.getElementById('screen-list');
      container.innerHTML = '';
      if (items.length === 0) { container.innerHTML = '<div style="text-align:center; padding:20px;">Nenhum aniversariante.</div>'; return; }

      items.forEach(item => {
          const div = document.createElement('div');
          div.className = `list-item ${item.isToday ? 'today' : ''}`;
          const week = item.date.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.','');
          const monthShort = item.date.toLocaleDateString('pt-BR', { month: 'short' }).replace('.','');
          const day = item.day < 10 ? '0'+item.day : item.day;
          
          let btn = '';
          if (item.isToday) {
              const safeName = item.name.replace(/'/g, "\\'");
              btn = `<button class="wa-btn" onclick="shareWa('${safeName}')">üí¨ Parab√©ns</button>`;
          }

          div.innerHTML = `
            <div class="date-badge">
                <span class="db-day">${day}</span>
                <span class="db-week">${week}</span>
                <span class="db-month">${monthShort}</span>
            </div>
            <span class="name-text">${item.name}</span>
            ${btn}
          `;
          container.appendChild(div);
      });
  }

  function updateHero(items, isSearch) {
      const hn = document.getElementById('hero-names'), hm = document.getElementById('hero-msg'), he = document.getElementById('hero-emoji');
      if (isSearch) { he.innerText = "üîç"; hn.innerText = `${items.length} Encontrados`; hm.innerText = "Resultado da pesquisa"; return; }
      
      const todays = items.filter(i => i.isToday);
      if (todays.length > 0) { 
          he.innerText = "üéÇ"; 
          hn.innerHTML = todays.map(i => i.name).join('<br>'); 
          const randomPhrase = frases[Math.floor(Math.random() * frases.length)];
          hm.innerText = randomPhrase + ASSINATURA; 
      }
      else { 
          he.innerText = "üìÖ"; 
          hn.innerText = "Agenda do M√™s"; 
          hm.innerText = "Confira a lista completa abaixo.";
      }
  }

  // --- IMPRESS√ÉO ---
  function prepareAndPrint() {
      const mesStr = currentDate.toLocaleDateString('pt-BR', { month: 'long' }).toUpperCase();
      const anoStr = currentDate.getFullYear();
      document.getElementById('print-title').innerText = isSearchMode ? "RESULTADO DA BUSCA" : `ANIVERSARIANTES DE ${mesStr} / ${anoStr}`;

      const printData = [...eventsCache].sort((a,b) => {
          if (a.month !== b.month) return a.month - b.month;
          return a.day - b.day;
      });

      const grid = document.getElementById('print-list-grid');
      grid.innerHTML = ''; 

      if(printData.length === 0) {
          grid.innerHTML = '<div style="grid-column: span 2; text-align:center;">Nenhum aniversariante encontrado.</div>';
      } else {
          printData.forEach(item => {
              const week = item.date.toLocaleDateString('pt-BR', { weekday: 'short' }).replace('.','');
              const monthShort = item.date.toLocaleDateString('pt-BR', { month: 'short' }).replace('.','');
              const d = item.day < 10 ? '0'+item.day : item.day;
              
              const el = document.createElement('div');
              el.className = 'p-item';
              el.innerHTML = `
                  <div class="p-date-box">
                      <span class="pd-day">${d}</span>
                      <span class="pd-week">${week}</span>
                      <span class="pd-month">${monthShort}</span>
                  </div>
                  <span class="p-name">${item.name}</span>
              `;
              grid.appendChild(el);
          });
      }

      window.print();
  }

  // --- UTIL ---
  function changeMonth(s) { if(isSearchMode) resetSearch(); currentDate.setMonth(currentDate.getMonth() + s); currentDate.setDate(1); init(); }
  function updateScreenHeader() { const s = currentDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }); document.getElementById('screen-month-title').innerText = s.charAt(0).toUpperCase() + s.slice(1); }
  let st; function handleSearch() { clearTimeout(st); const v = document.getElementById('search-input').value.trim(); st = setTimeout(() => { if (v) { isSearchMode = true; fetchEvents(v); } else { resetSearch(); } }, 600); }
  function resetSearch() { document.getElementById('search-input').value = ''; isSearchMode = false; currentDate = new Date(); init(); }
  
  function shareWa(fullName) { 
      const firstName = fullName.split(' ')[0]; 
      const randomPhrase = frases[Math.floor(Math.random() * frases.length)];
      const txt = `üéâ *Parab√©ns ${firstName}!* üéÇ\n\n${randomPhrase}\n\nCom carinho,\nSecretaria Municipal de Educa√ß√£o de Orindi√∫va`;
      window.open("https://api.whatsapp.com/send?text=" + encodeURIComponent(txt)); 
  }

  function setupParticles() {
      const l = document.getElementById('particle-layer');
      const c = () => { const p = document.createElement('span'); p.className = 'particle'; p.innerText = ['üéà','‚ú®','üéâ'][Math.floor(Math.random()*3)]; p.style.left = Math.random()*100+'%'; p.style.fontSize = (Math.random()+1)+'rem'; l.appendChild(p); setTimeout(()=>p.remove(),2000); };
      document.getElementById('hero-box').addEventListener('mouseenter', ()=>{ if(!particleInterval) particleInterval = setInterval(c, 150); });
      document.getElementById('hero-box').addEventListener('mouseleave', ()=>{ clearInterval(particleInterval); particleInterval = null; });
  }

  init();
</script>

</body>
</html>
